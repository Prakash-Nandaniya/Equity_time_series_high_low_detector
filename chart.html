<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Closing Price Chart</title>
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { margin: 0; background: #0f1114; }
    #chart { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <div id="chart"></div>
  <script>
    async function loadCSV() {
      const res = await fetch("chart.csv");
      if (!res.ok) throw new Error("chart.csv not found");
      const text = await res.text();

      const rows = text.trim().split("\n");
      if (rows.length <= 1) throw new Error("CSV file has no data rows");

      const headers = rows[0].split(",").map(h => h.trim().toLowerCase());
      const timeIndex = headers.indexOf("time");
      const closeIndex = headers.indexOf("close");
      const labelIndex = headers.indexOf("label");
      const predictedIndex = headers.indexOf("predicted_label");

      if (timeIndex === -1 || closeIndex === -1) {
        throw new Error("CSV must have 'time' and 'Close' columns");
      }

      let data = [];
      let markers = [];

      for (let i = 1; i < rows.length; i++) {
        const cols = rows[i].split(",").map(x => x.trim());
        const timeStr = cols[timeIndex];
        const closeVal = parseFloat(cols[closeIndex]);
        if (!timeStr || isNaN(closeVal)) continue;

        const [year, month, day] = timeStr.split("-").map(Number);
        if (!year || !month || !day) continue;
        const timeObj = { year, month, day };

        data.push({ time: timeObj, value: closeVal });

        // üî¥ Red marker for Label = R
        if (labelIndex !== -1 && cols[labelIndex]?.toUpperCase() === "R") {
          markers.push({
            time: timeObj,
            position: "aboveBar",
            color: "red",
            shape: "circle",
            size: 1,
          });
        }

        // üü° Yellow marker for Predicted_Label = R
        if (predictedIndex !== -1 && cols[predictedIndex]?.toUpperCase() === "R") {
          markers.push({
            time: timeObj,
            position: "belowBar",
            color: "yellow",
            shape: "circle",
            size: 1,
          });
        }
      }

      // ‚úÖ Sort by date ascending
      data.sort((a, b) => {
        const d1 = new Date(a.time.year, a.time.month - 1, a.time.day);
        const d2 = new Date(b.time.year, b.time.month - 1, b.time.day);
        return d1 - d2;
      });

      const chart = LightweightCharts.createChart(document.getElementById("chart"), {
        layout: { background: { color: "#0f1114" }, textColor: "#DDD" },
        grid: { vertLines: { color: "#222" }, horzLines: { color: "#222" } },
        timeScale: { timeVisible: true, secondsVisible: false },
      });

      const lineSeries = chart.addLineSeries({ color: "#4CAF50", lineWidth: 2 });
      lineSeries.setData(data);
      lineSeries.setMarkers(markers);
      chart.timeScale().fitContent();
    }

    loadCSV().catch(err => console.error("‚ùå Error:", err.message));
  </script>
</body>
</html>