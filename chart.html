<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Closing Price Chart</title>
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { margin: 0; background: #0f1114; }
    #chart { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <div id="chart"></div>
  <script>
    async function loadCSV() {
      const res = await fetch("chart.csv");
      if (!res.ok) throw new Error("chart.csv not found");
      const text = await res.text();

      const rows = text.trim().split("\n").slice(1);
      const data = [];
      const markers = [];

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cols = row.split(",").map(x => x.trim());
        if (cols.length < 6) continue;

        const [time, open, high, low, close, label] = cols;
        const c = parseFloat(close);
        if (isNaN(c)) continue;

        const formattedTime = new Date(time).toISOString().slice(0, 10);
        data.push({ time: formattedTime, value: c });

        // if label is R, add marker (red dot)
        if (label && label.toUpperCase() === 'R') {
          markers.push({
            time: formattedTime,
            position: 'aboveBar',
            color: 'red',
            shape: 'circle',
            size: 2
          });
          console.log(`ðŸ”´ R at ${formattedTime} | close=${c}`);
        }
      }

      console.log(`âœ… Loaded ${data.length} points, ${markers.length} red markers`);

      const chart = LightweightCharts.createChart(document.getElementById("chart"), {
        layout: { background: { color: "#0f1114" }, textColor: "#DDD" },
        grid: { vertLines: { color: "#222" }, horzLines: { color: "#222" } },
        timeScale: { timeVisible: true, secondsVisible: false },
      });

      const lineSeries = chart.addLineSeries({
        color: "#4CAF50",
        lineWidth: 2,
      });

      lineSeries.setData(data);
      lineSeries.setMarkers(markers); // ðŸ‘ˆ This is the key fix!

      chart.timeScale().fitContent();
    }

    loadCSV().catch(console.error);
  </script>
</body>
</html>